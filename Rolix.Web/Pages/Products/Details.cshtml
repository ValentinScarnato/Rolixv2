@page
@model Rolix.Web.Pages.Products.DetailsModel
@using Rolix.Web.Helpers
@{
    ViewData["Title"] = Model.Product?.Name;
    var currency = HttpContext.Session.GetString(Rolix.Web.Models.SessionKeys.Currency) ?? "CHF";
}

<div class="ambient-light light-1" style="top: -20%; left: 20%; width: 600px; height: 600px; opacity: 0.4;"></div>

@if (Model.Product != null)
{
    <div class="product-details-container">

        @if (TempData["QuoteSuccess"] is string quoteMessage)
        {
            <div class="alert alert-success" style="margin-bottom: 20px;">@quoteMessage</div>
        }

        @if (TempData["QuoteWarning"] is string quoteWarning)
        {
            <div class="alert alert-warning" style="margin-bottom: 20px;">@quoteWarning</div>
        }

        <div class="product-details-card fade-in-up">

            <div class="product-image-wrapper">

                <a asp-page="/Products/Index" class="btn-back-catalog">
                    &larr; @LocalizationHelper.Get("Common_BackToCatalog", HttpContext)
                </a>

                <div class="watch-glow"></div>

                @if (!string.IsNullOrEmpty(Model.Product.ImageBase64))
                {
                    <img src="@Model.Product.ImageBase64"
                         alt="@Model.Product.Name"
                         class="product-details-image" />
                }
                else
                {
                    <div class="product-details-image-placeholder">
                        <span>Pas d'image</span>
                    </div>
                }

                <div class="specs-grid fade-in-up delay-600">
                    <div class="spec-item">
                        <span class="spec-icon">âŒ€</span>
                        <span class="spec-label">@LocalizationHelper.Get("Product_Diameter", HttpContext)</span>
                        <span class="spec-value">@Model.Product.Dimensions mm</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-icon">â—†</span>
                        <span class="spec-label">@LocalizationHelper.Get("Product_Material", HttpContext)</span>
                        <span class="spec-value">@Model.Product.Materiaux</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-icon">âš™</span>
                        <span class="spec-label">@LocalizationHelper.Get("Product_Movement", HttpContext)</span>
                        <span class="spec-value">@Model.Product.Mouvement</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-icon">ðŸ’§</span>
                        <span class="spec-label">@LocalizationHelper.Get("Product_WaterResistance", HttpContext)</span>
                        <span class="spec-value">@Model.Product.Etancheite m</span>
                    </div>
                </div>
            </div>

            <div class="product-details-info">

                <div class="fade-in-up delay-200">
                    <span class="product-reference">RÃ©f. 126233 (Exemple)</span>
                    <h1 class="product-title">@Model.Product.Name</h1>

                    <div class="price-wrapper">
                        <span class="price">
                            @CurrencyHelper.FormatPrice(Model.Product.Price, currency)
                        </span>
                        <span class="tax-label">@LocalizationHelper.Get("Common_VATIncluded", HttpContext)</span>
                    </div>
                </div>

                <div class="separator-line fade-in-up delay-400"></div>

                <div class="description-block fade-in-up delay-400">
                    @{
                        var langCode = HttpContext.Session.GetString(Rolix.Web.Models.SessionKeys.Language) ?? "fr";
                        var description = (langCode == "en" && !string.IsNullOrEmpty(Model.Product.DescriptionEn)) 
                                        ? Model.Product.DescriptionEn 
                                        : Model.Product.Description;
                    }

                    @if (!string.IsNullOrEmpty(description))
                    {
                        <h3>@LocalizationHelper.Get("Product_ModelSpirit", HttpContext)</h3>
                        <p class="description">@description</p>
                    }
                    else
                    {
                        <h3>Description</h3>
                        <p class="description muted">Aucune description n'est disponible pour ce modÃ¨le.</p>
                    }
                </div>

                <div class="action-block fade-in-up delay-600">
                    <form method="post" asp-page-handler="Quote" class="quote-form">
                        <input type="hidden" name="id" value="@Model.Product.Id" />
                        <input type="hidden" name="comment" id="quote-comment" value="@Model.Comment" />

                        @if (Model.HasPendingQuote)
                        {
                            <button type="button" class="btn-primary-large" disabled>
                                @LocalizationHelper.Get("Product_QuoteSent", HttpContext)
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn-primary-large" id="open-quote-modal">
                                @LocalizationHelper.Get("Product_RequestQuote", HttpContext)
                            </button>
                            <button type="submit" class="btn-primary-large" id="submit-quote" style="display:none;">
                                @LocalizationHelper.Get("Product_RequestQuote", HttpContext)
                            </button>
                        }
                    </form>

                    <div class="trust-signals">
                        <div class="trust-item">
                            <span class="trust-icon">âœ¦</span>
                            <span>@LocalizationHelper.Get("Product_Guarantee5Years", HttpContext)</span>
                        </div>
                        <div class="trust-item">
                            <span class="trust-icon">âœ¦</span>
                            <span>@LocalizationHelper.Get("Product_SecureDelivery", HttpContext)</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="quote-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999;">
        <div style="max-width: 560px; margin: 10vh auto; background: rgba(20,20,20,0.95); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 18px;">
            <h3 style="margin-top: 0;">Commentaire (optionnel)</h3>
            <div class="form-group" style="margin-bottom: 12px;">
                <textarea id="quote-modal-comment" class="glass-input-clean" rows="4" placeholder="Ajoutez un commentaire pour votre demande...">@Model.Comment</textarea>
            </div>
            <div style="display:flex; gap: 10px; justify-content:flex-end;">
                <button type="button" class="btn-secondary-glass" id="close-quote-modal">Annuler</button>
                <button type="button" class="btn-primary-large" id="confirm-quote">Envoyer la demande</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const openBtn = document.getElementById('open-quote-modal');
            const modal = document.getElementById('quote-modal');
            const closeBtn = document.getElementById('close-quote-modal');
            const confirmBtn = document.getElementById('confirm-quote');
            const modalComment = document.getElementById('quote-modal-comment');
            const hiddenComment = document.getElementById('quote-comment');
            const submitBtn = document.getElementById('submit-quote');

            if (!openBtn || !modal || !closeBtn || !confirmBtn || !modalComment || !hiddenComment || !submitBtn) {
                return;
            }

            function openModal() {
                modal.style.display = 'block';
                modalComment.focus();
            }

            function closeModal() {
                modal.style.display = 'none';
            }

            openBtn.addEventListener('click', openModal);
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });

            confirmBtn.addEventListener('click', function() {
                hiddenComment.value = modalComment.value || '';
                openBtn.disabled = true;
                confirmBtn.disabled = true;
                submitBtn.click();
            });
        })();
    </script>
}
else
{
    <div style="text-align: center; margin-top: 100px; color: white;">
        <h2>@LocalizationHelper.Get("Product_NotFound", HttpContext)</h2>
        <a asp-page="/Products/Index" class="btn-primary" style="margin-top: 20px;">@LocalizationHelper.Get("Product_BackToCollection", HttpContext)</a>
    </div>
}